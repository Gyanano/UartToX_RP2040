# UartToX 系统架构设计

## 项目概述

UartToX 是一个基于 RP2040 的多协议转换工具，通过 USB/串口与 PC 通信，支持将数据转换为 I2C、SPI 等多种协议，实现单串口控制多种通信设备。

---

## 1. 系统架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              PC 端                                       │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                  │
│  │  终端/Shell  │    │  Python脚本 │    │   GUI工具   │                  │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘                  │
│         └──────────────────┼──────────────────┘                         │
│                            │                                            │
│                    USB CDC / UART                                       │
└────────────────────────────┼────────────────────────────────────────────┘
                             │
┌────────────────────────────┼────────────────────────────────────────────┐
│                        RP2040                                           │
│                            │                                            │
│  ┌─────────────────────────▼─────────────────────────────────┐          │
│  │                    Core 0 (主核心)                         │          │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐              │          │
│  │  │ USB/UART  │  │  命令解析  │  │  响应生成  │              │          │
│  │  │   驱动    │──│   器      │──│    器     │              │          │
│  │  └───────────┘  └───────────┘  └───────────┘              │          │
│  └───────────────────────┬───────────────────────────────────┘          │
│                          │ FIFO 队列                                    │
│  ┌───────────────────────▼───────────────────────────────────┐          │
│  │                    Core 1 (协议核心)                       │          │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐       │          │
│  │  │   I2C   │  │   SPI   │  │  UART   │  │  1-Wire │       │          │
│  │  │  (PIO)  │  │  (PIO)  │  │  (PIO)  │  │  (PIO)  │       │          │
│  │  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘       │          │
│  └───────┼────────────┼───────────┼────────────┼─────────────┘          │
│          │            │           │            │                        │
└──────────┼────────────┼───────────┼────────────┼────────────────────────┘
           │            │           │            │
     ┌─────▼─────┐ ┌────▼────┐ ┌────▼────┐ ┌────▼────┐
     │ I2C 设备  │ │SPI 设备 │ │UART设备 │ │1-Wire   │
     │(传感器等) │ │(Flash等)│ │(模块等) │ │(DS18B20)│
     └───────────┘ └─────────┘ └─────────┘ └─────────┘
```

---

## 2. 双核分工

### Core 0 - 通信与命令处理
- USB CDC 驱动 (TinyUSB)
- 命令行解析器
- 响应格式化
- 系统状态管理

### Core 1 - 协议执行
- PIO 状态机管理
- I2C/SPI/UART 协议实现
- 时序精确控制
- DMA 数据传输

### 核间通信
- 使用 RP2040 硬件 FIFO (32位 x 8深度)
- 共享内存用于大数据块传输
- 信号量同步

---

## 3. 引脚分配

```
RP2040 引脚分配表
═══════════════════════════════════════════════════════
功能          │ GPIO    │ 说明
═══════════════════════════════════════════════════════
USB           │ 内置    │ USB CDC 通信
───────────────────────────────────────────────────────
I2C0_SDA      │ GP4     │ I2C 数据线 (PIO)
I2C0_SCL      │ GP5     │ I2C 时钟线 (PIO)
I2C1_SDA      │ GP6     │ I2C 备用通道
I2C1_SCL      │ GP7     │ I2C 备用通道
───────────────────────────────────────────────────────
SPI_MISO      │ GP16    │ SPI 主入从出 (PIO)
SPI_MOSI      │ GP17    │ SPI 主出从入 (PIO)
SPI_SCK       │ GP18    │ SPI 时钟 (PIO)
SPI_CS0       │ GP19    │ SPI 片选0
SPI_CS1       │ GP20    │ SPI 片选1
SPI_CS2       │ GP21    │ SPI 片选2
───────────────────────────────────────────────────────
UART_TX       │ GP8     │ UART 发送 (PIO)
UART_RX       │ GP9     │ UART 接收 (PIO)
───────────────────────────────────────────────────────
ONEWIRE       │ GP10    │ 1-Wire 总线 (PIO)
───────────────────────────────────────────────────────
GPIO_0        │ GP11    │ 通用 GPIO
GPIO_1        │ GP12    │ 通用 GPIO
GPIO_2        │ GP13    │ 通用 GPIO
GPIO_3        │ GP14    │ 通用 GPIO
───────────────────────────────────────────────────────
LED           │ GP25    │ 状态指示灯
═══════════════════════════════════════════════════════
```

---

## 4. 软件模块

```
src/
├── main.c                  # 主程序入口
├── core0/
│   ├── shell.c             # Shell 命令解析器
│   ├── usb_cdc.c           # USB CDC 驱动
│   └── response.c          # 响应格式化
├── core1/
│   ├── protocol_manager.c  # 协议管理器
│   ├── i2c_pio.c           # I2C PIO 实现
│   ├── spi_pio.c           # SPI PIO 实现
│   ├── uart_pio.c          # UART PIO 实现
│   └── onewire_pio.c       # 1-Wire PIO 实现
├── common/
│   ├── fifo_ipc.c          # 核间通信
│   ├── ring_buffer.c       # 环形缓冲区
│   └── utils.c             # 工具函数
└── pio/
    ├── i2c.pio             # I2C PIO 程序
    ├── spi.pio             # SPI PIO 程序
    ├── uart.pio            # UART PIO 程序
    └── onewire.pio         # 1-Wire PIO 程序
```

---

## 5. 高速通信设计

### 5.1 USB CDC 配置
- 波特率：最高 12 Mbps (USB Full Speed)
- 缓冲区：双缓冲，每个 4KB
- 使用 DMA 传输

### 5.2 传输模式

| 模式 | 说明 | 适用场景 |
|------|------|----------|
| TEXT | 文本命令模式 | 交互式调试 |
| BIN  | 二进制模式 | 高速批量传输 |
| STREAM | 流模式 | 连续数据采集 |

### 5.3 二进制传输协议

```
二进制帧格式：
┌──────┬──────┬──────┬────────────┬──────┬──────┐
│ HEAD │ LEN  │ CMD  │   DATA     │ CRC  │ TAIL │
│ 0xAA │ 2B   │ 1B   │   0-4096B  │ 2B   │ 0x55 │
└──────┴──────┴──────┴────────────┴──────┴──────┘
```

---

## 6. 性能指标

| 指标 | 目标值 |
|------|--------|
| USB 吞吐量 | > 1 MB/s |
| I2C 最高速率 | 1 MHz (Fast Mode Plus) |
| SPI 最高速率 | 20 MHz |
| UART 最高波特率 | 3 Mbps |
| 命令响应延迟 | < 1 ms |
